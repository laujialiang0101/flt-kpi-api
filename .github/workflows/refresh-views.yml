name: Refresh Materialized Views

on:
  schedule:
    # Every 15 minutes during business hours (8am-11pm Malaysia Time = 0am-3pm UTC)
    # Note: GitHub Actions uses UTC timezone. Concurrent refresh does not block reads.
    - cron: '*/15 0-15 * * *'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Refresh Materialized Views
        run: |
          echo "Triggering MV refresh at $(date)"
          response=$(curl -s -X POST "https://flt-kpi-api.onrender.com/api/v1/admin/refresh-views?api_key=${{ secrets.REFRESH_API_KEY }}")
          echo "Response: $response"

          # Check if refresh was successful
          if echo "$response" | grep -q '"success":true'; then
            echo "Refresh completed successfully!"
          else
            echo "Refresh may have failed. Check API logs."
            exit 1
          fi
        env:
          REFRESH_API_KEY: ${{ secrets.REFRESH_API_KEY }}
