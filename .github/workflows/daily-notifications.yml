name: Daily Push Notifications

on:
  schedule:
    # 8:00 AM Malaysia Time = 0:00 UTC
    - cron: '0 0 * * *'
    # 10:30 PM Malaysia Time = 14:30 UTC
    - cron: '30 14 * * *'
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      notification_type:
        description: 'Type of notification to send'
        required: true
        default: 'morning'
        type: choice
        options:
          - morning
          - evening

jobs:
  send-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Determine notification type
        id: determine-type
        run: |
          # For scheduled runs, determine type based on UTC hour
          # 0:00 UTC = 8:00 AM Malaysia (morning)
          # 14:30 UTC = 10:30 PM Malaysia (evening)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.notification_type }}" >> $GITHUB_OUTPUT
          else
            HOUR=$(date -u +%H)
            if [ "$HOUR" = "00" ]; then
              echo "type=morning" >> $GITHUB_OUTPUT
            else
              echo "type=evening" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Send Morning Briefing
        if: steps.determine-type.outputs.type == 'morning'
        run: |
          echo "Sending morning briefing at $(date)"
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://flt-kpi-api.onrender.com/api/v1/push/morning-briefing?api_key=${{ secrets.PUSH_API_KEY }}")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" = "200" ]; then
            echo "Morning briefing sent successfully!"
          else
            echo "Morning briefing failed with status $http_code"
            exit 1
          fi

      - name: Send Evening Recap
        if: steps.determine-type.outputs.type == 'evening'
        run: |
          echo "Sending evening recap at $(date)"
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://flt-kpi-api.onrender.com/api/v1/push/evening-recap?api_key=${{ secrets.PUSH_API_KEY }}")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" = "200" ]; then
            echo "Evening recap sent successfully!"
          else
            echo "Evening recap failed with status $http_code"
            exit 1
          fi
