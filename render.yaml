services:
  # Main API Service
  - type: web
    name: flt-kpi-api
    runtime: python
    plan: starter
    region: singapore
    autoDeploy: true
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn main:app --host 0.0.0.0 --port $PORT --loop asyncio
    envVars:
      - key: DB_PASSWORD
        sync: false  # Set manually in Render dashboard

  # ============================================================================
  # NOTIFICATION CRON JOBS
  # ============================================================================
  # Schedule Reference (MYT = UTC+8):
  #   8am MYT  = 0:00 UTC    12pm MYT = 4:00 UTC    6pm MYT  = 10:00 UTC
  #   9pm MYT  = 13:00 UTC   10pm MYT = 14:00 UTC   11pm MYT = 15:00 UTC

  # Morning Briefing at 8am MYT (Sun-Thu for East Coast MY)
  # - Yesterday's performance summary
  # - Today's target reminder
  # - Motivational kickoff message
  - type: cron
    name: flt-morning-briefing
    runtime: python
    region: singapore
    schedule: "0 0 * * 0-4"
    buildCommand: pip install requests
    startCommand: python cron_morning.py

  # Midday Check at 12pm MYT (Sun-Thu for East Coast MY)
  # - Progress vs daily target
  # - Encourage afternoon push
  - type: cron
    name: flt-midday-check
    runtime: python
    region: singapore
    schedule: "0 4 * * 0-4"
    buildCommand: pip install requests
    startCommand: python cron_midday.py

  # End of Day Recap at 6pm MYT (Sun-Thu for East Coast MY)
  # - Today's total commission earned
  # - Rank movement
  # - Tomorrow teaser
  - type: cron
    name: flt-eod-recap
    runtime: python
    region: singapore
    schedule: "0 10 * * 0-4"
    buildCommand: pip install requests
    startCommand: python cron_eod.py

  # Commission Threshold Check every 30 min during business hours (Sun-Thu, 9am-9pm MYT)
  # - Tracks cumulative daily commission
  # - Notifies at thresholds: RM10, RM20, RM30, RM50, RM100
  # - Each threshold notifies ONCE per day
  - type: cron
    name: flt-commission-check
    runtime: python
    region: singapore
    schedule: "*/30 1-13 * * 0-4"
    buildCommand: pip install requests
    startCommand: python cron_commission.py

  # Daily Milestones at 9pm MYT (daily)
  # - Rank change celebrations
  # - Streak milestones (3, 7, 14, 30 days)
  # - Target milestone achievements (25%, 50%, 75%, 100%)
  # - First-time achievements
  - type: cron
    name: flt-daily-milestones
    runtime: python
    region: singapore
    schedule: "0 13 * * *"
    buildCommand: pip install requests
    startCommand: python cron_milestones.py

  # ============================================================================
  # SYSTEM CRON JOBS
  # ============================================================================

  # Weekly Summary Verification - Friday 8am MYT (start of weekend)
  # - Verifies daily_sales_summary accuracy vs raw tables
  # - Fixes any discrepancies found
  # - No MV refresh needed (MVs converted to views - always fresh)
  - type: cron
    name: flt-weekly-verify
    runtime: python
    region: singapore
    schedule: "0 0 * * 5"
    buildCommand: pip install requests
    startCommand: python cron_weekly_verify.py
